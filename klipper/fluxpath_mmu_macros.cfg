# FluxPath MMU â€“ Klipper integration (software-only, no motion yet)
#
# 1. Include this file in printer.cfg:
#    [include ~/FluxPath/klipper/fluxpath_mmu_macros.cfg]
#
# 2. Ensure gcode_shell_command is enabled in Klipper.
#
# 3. These macros currently call FluxPath API endpoints only.
#    They do NOT move hardware. Motion sequences will be added
#    after calibration.

[gcode_shell_command FLUXPATH_MMU]
command: curl -s "http://localhost:9876/mmu/%(action)s"
timeout: 30.0
verbose: True

[gcode_macro MMU_LOAD_SLOT]
description: "Request FluxPath to load a given MMU slot (no motion yet)"
gcode:
  {% set s = params.SLOT|int %}
  RESPOND PREFIX="FluxPath" MSG="Requesting load of slot {{s}} via FluxPath"
  RUN_SHELL_COMMAND CMD=FLUXPATH_MMU PARAMS="action=load_slot_{{s}}"

[gcode_macro MMU_UNLOAD]
description: "Request FluxPath to unload filament (no motion yet)"
gcode:
  RESPOND PREFIX="FluxPath" MSG="Requesting unload via FluxPath"
  RUN_SHELL_COMMAND CMD=FLUXPATH_MMU PARAMS="action=unload"

[gcode_macro MMU_TOOL_CHANGE]
description: "Toolchange macro that delegates to FluxPath (no motion yet)"
gcode:
  {% set t = params.TOOL|default(0)|int %}
  RESPOND PREFIX="FluxPath" MSG="Toolchange requested to tool {{t}} (slot {{t}})"
  RUN_SHELL_COMMAND CMD=FLUXPATH_MMU PARAMS="action=tool_{{t}}"

[gcode_macro MMU_RECOVER]
description: "Request FluxPath to clear MMU error state"
gcode:
  RESPOND PREFIX="FluxPath" MSG="Requesting MMU error recovery via FluxPath"
  RUN_SHELL_COMMAND CMD=FLUXPATH_MMU PARAMS="action=recover"
