# ============================================
# File: mmu/mmu_unload.cfg
# Location: ~/printer_data/config/mmu/
#
# Purpose:
#   Unload filament for active lane from NOZZLE â†’ PARK.
# ============================================

[gcode_macro MMU_TIP_FORM]
gcode:
  G91
  G1 E-2.0 F1800
  G1 E1.0 F600
  G1 E-3.0 F1800
  G90

[gcode_macro MMU_CUT_SEQUENCE]
gcode:
  {% set v = printer["gcode_macro MMU_VARS"] %}
  SET_SERVO SERVO={v.cutter_servo} ANGLE={v.cutter_angle_open}
  G4 P200
  MMU_MOVE_E E=5 F600
  SET_SERVO SERVO={v.cutter_servo} ANGLE={v.cutter_angle_cut}
  G4 P200
  MMU_MOVE_E E=3 F600
  SET_SERVO SERVO={v.cutter_servo} ANGLE={v.cutter_angle_open}

[gcode_macro MMU_UNLOAD]
gcode:
  {% set v = printer["gcode_macro MMU_VARS"] %}
  RESPOND PREFIX=MMU MSG="UNLOAD: lane {{ v.active_lane }} from nozzle to park"

  MMU_TIP_FORM

  MMU_MOVE_E E={-(v.filament_sensor_to_extruder + 5)} F=1800

  {% if printer["filament_switch_sensor filament_sensor"].filament_detected %}
    MMU_ERROR MSG="Filament sensor still triggered after retract. Jam suspected."
  {% endif %}

  MMU_MOVE_E E={-v.cutter_to_filament_sensor} F=1800

  MMU_CUT_SEQUENCE

  MMU_PARK

  RESPOND PREFIX=MMU MSG="UNLOAD complete, lane {{ v.active_lane }} parked"
