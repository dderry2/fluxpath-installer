# MARKER: FluxPath/mmu
# ============================================
# File: mmu/mmu_primitives.cfg
# Location: ~/printer_data/config/mmu/
#
# Purpose:
#   Low-level movement + lane selection.
#   Movement is still single-path; lanes are logical.
# ============================================

[gcode_macro MMU_GET_PARKING_TO_CUTTER]
description: Internal helper to get lane-specific parking_to_cutter
gcode:
  {% set v = printer["gcode_macro MMU_VARS"] %}
  {% set lane = v.active_lane|int %}
  {% if lane == 1 %}
    SET_GCODE_VARIABLE MACRO=MMU_VARS VARIABLE=parking_to_cutter VALUE={v.parking_to_cutter_1}
  {% elif lane == 2 %}
    SET_GCODE_VARIABLE MACRO=MMU_VARS VARIABLE=parking_to_cutter VALUE={v.parking_to_cutter_2}
  {% elif lane == 3 %}
    SET_GCODE_VARIABLE MACRO=MMU_VARS VARIABLE=parking_to_cutter VALUE={v.parking_to_cutter_3}
  {% elif lane == 4 %}
    SET_GCODE_VARIABLE MACRO=MMU_VARS VARIABLE=parking_to_cutter VALUE={v.parking_to_cutter_4}
  {% else %}
    SET_GCODE_VARIABLE MACRO=MMU_VARS VARIABLE=parking_to_cutter VALUE={v.parking_to_cutter_1}
  {% endif %}

[gcode_macro MMU_SET_LANE]
description: Set active MMU lane (1â€“4)
gcode:
  {% set lane = params.LANE|int %}
  {% set v = printer["gcode_macro MMU_VARS"] %}
  {% if lane < 1 or lane > v.mmu_lanes %}
    RESPOND PREFIX=MMU MSG="ERROR: Invalid lane {{ lane }} (mmu_lanes={{ v.mmu_lanes }})"
  {% else %}
    SET_GCODE_VARIABLE MACRO=MMU_VARS VARIABLE=active_lane VALUE={lane}
    RESPOND PREFIX=MMU MSG="Active MMU lane set to {{ lane }}"
  {% endif %}

[gcode_macro MMU_DISABLE]
gcode:
  SET_STEPPER_ENABLE STEPPER=mmu_extruder ENABLE=0

[gcode_macro MMU_ENABLE]
gcode:
  SET_STEPPER_ENABLE STEPPER=mmu_extruder ENABLE=1

[gcode_macro MMU_MOVE_E]
gcode:
  {% set e = params.E|float %}
  {% set f = params.F|default(1200)|float %}
  MMU_ENABLE
  G91
  G1 E{e} F{f}
  G90

[gcode_macro MMU_PARK]
gcode:
  {% set v = printer["gcode_macro MMU_VARS"] %}
  MMU_GET_PARKING_TO_CUTTER
  {% set v = printer["gcode_macro MMU_VARS"] %}
  MMU_MOVE_E E={-v.parking_to_cutter} F=1800
  RESPOND PREFIX=MMU MSG="MMU lane {{ v.active_lane }} parked inside splitter"

[gcode_macro MMU_MOVE_TO_CUTTER_FROM_PARK]
gcode:
  {% set v = printer["gcode_macro MMU_VARS"] %}
  MMU_GET_PARKING_TO_CUTTER
  {% set v = printer["gcode_macro MMU_VARS"] %}
  MMU_MOVE_E E={v.parking_to_cutter} F=1800

# ============================================
# Sensor-aware movement
# ============================================

[gcode_macro MMU_WAIT_FOR_FILAMENT_SENSOR]
description: Wait for post-cutter filament sensor to trigger
gcode:
  {% set timeout = params.TIMEOUT|default(2000)|int %}
  {% set start = printer.clock.realtime %}
  {% set sensor = printer["filament_switch_sensor filament_sensor"] %}

  RESPOND PREFIX=MMU MSG="Waiting for filament sensor..."

  {% while printer.clock.realtime - start < timeout %}
    {% if sensor.filament_detected %}
      RESPOND PREFIX=MMU MSG="Filament sensor triggered."
      {% break %}
    {% endif %}
    G4 P50
  {% endwhile %}

  {% if not sensor.filament_detected %}
    MMU_ERROR MSG="Expected filament sensor trigger, but it never occurred."
  {% endif %}

[gcode_macro MMU_MOVE_TO_FILAMENT_SENSOR_EXPECT]
description: Move forward until filament sensor should trigger
gcode:
  {% set v = printer["gcode_macro MMU_VARS"] %}
  MMU_MOVE_E E={v.cutter_to_filament_sensor} F=1800
  MMU_WAIT_FOR_FILAMENT_SENSOR TIMEOUT=2000
